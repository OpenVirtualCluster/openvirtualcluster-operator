name: Release

on:
  push:
    tags:
      - 'v*.*.*'
env:
  RELEASE_VERSION: ${{ github.ref_name }}
  IMG: ghcr.io/openvirtualcluster/openvirtualcluster-operator:${{ github.ref_name }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push
        run: |
          make docker-buildx
        env:
          IMG: ${{ env.IMG }}

  release:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create directory for changelog config
        run: mkdir -p .github/workflows/changelog_builder

      - name: Create changelog config
        run: |
          cat > .github/workflows/changelog_builder/config.json << EOF
          {
            "categories": [
              {
                "title": "## 🚀 Features",
                "labels": ["feature", "enhancement"]
              },
              {
                "title": "## 🐛 Fixes",
                "labels": ["fix", "bugfix", "bug"]
              },
              {
                "title": "## 📝 Documentation",
                "labels": ["documentation"]
              },
              {
                "title": "## 🧰 Maintenance",
                "labels": ["chore", "maintenance"]
              }
            ],
            "ignore_labels": ["ignore"],
            "sort": "ASC",
            "template": "${{CHANGELOG}}"
          }
          EOF

      - name: "Build Changelog"
        id: github_release
        uses: mikepenz/release-changelog-builder-action@v3
        with:
          configuration: ".github/workflows/changelog_builder/config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ env.RELEASE_VERSION }}
          name: ${{ env.RELEASE_VERSION }}
          body: ${{ steps.github_release.outputs.changelog }}
          generate_release_notes: true

  build-installer:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version-file: 'go.mod'

      - name: Build installer
        run: |
          make build-installer
        env:
          IMG: ${{ env.IMG }}

      - name: Upload installer artifact
        uses: actions/upload-artifact@v3
        with:
          name: installer
          path: dist/install.yaml

      - name: Upload installer to release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ env.RELEASE_VERSION }}
          files: dist/install.yaml 